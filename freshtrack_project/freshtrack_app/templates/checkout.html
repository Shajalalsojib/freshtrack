{% extends 'base.html' %}

{% block title %}Checkout - FreshTrack{% endblock %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto;">
    <h1>üõí Checkout</h1>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
        
        <!-- Order Summary -->
        <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <h2 style="margin-top: 0; color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">üì¶ Order Summary</h2>
            
            <div style="margin: 20px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <strong style="font-size: 18px;">{{ product.name }}</strong>
                </div>
                
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #666;">Seller:</span>
                        <span style="font-weight: 500;">{{ product.seller.company_name }}</span>
                    </div>
                    {% if product.has_discount %}
                    <div style="background: #fef3c7; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #92400e; font-weight: 600;">üè∑Ô∏è Discount:</span>
                            <span style="font-weight: 700; color: #dc2626;">{{ product.get_final_discount }}% OFF</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #666; text-decoration: line-through;">Original price:</span>
                            <span style="color: #666; text-decoration: line-through;">‡ß≥{{ product.price }}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #059669; font-weight: 600;">Discounted price:</span>
                            <span style="font-weight: 700; color: #dc2626;">‡ß≥{{ product.get_discounted_price|floatformat:2 }}</span>
                        </div>
                    </div>
                    {% else %}
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #666;">Price per unit:</span>
                        <span style="font-weight: 500;">‡ß≥{{ product.price }}</span>
                    </div>
                    {% endif %}
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #666;">Quantity:</span>
                        <span style="font-weight: 500;">{{ quantity }}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #666;">Available:</span>
                        <span style="font-weight: 500; color: #4CAF50;">{{ product.quantity }} units</span>
                    </div>
                </div>
                
                <div style="border-top: 2px dashed #ddd; padding-top: 15px; margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; font-size: 20px;">
                        <strong>Total Amount:</strong>
                        <strong style="color: #4CAF50;">‡ß≥{{ total_price }}</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Payment Method Selection -->
        <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <h2 style="margin-top: 0; color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">üí≥ Select Payment Method</h2>
            
            <form method="post" action="{% url 'initiate_payment' product.id %}" id="paymentForm" onsubmit="return validatePaymentForm()">
                {% csrf_token %}
                <input type="hidden" name="quantity" value="{{ quantity }}" id="quantityInput">
                
                <div style="margin: 20px 0;">
                    
                    <!-- Card Payment -->
                    <label class="payment-option">
                        <input type="radio" name="payment_method" value="card" id="payment_card" class="payment-radio" checked>
                        <div class="payment-card">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 32px;">üí≥</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 16px;">Credit / Debit Card</div>
                                    <div style="font-size: 13px; color: #666;">Visa, Mastercard, AMEX, Local Cards</div>
                                </div>
                            </div>
                        </div>
                    </label>
                    
                    <!-- bKash -->
                    <label class="payment-option">
                        <input type="radio" name="payment_method" value="bkash" id="payment_bkash" class="payment-radio">
                        <div class="payment-card">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 32px; color: #E2136E;">üì±</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 16px; color: #E2136E;">bKash</div>
                                    <div style="font-size: 13px; color: #666;">Mobile banking payment</div>
                                </div>
                            </div>
                        </div>
                    </label>
                    
                    <!-- Nagad -->
                    <label class="payment-option">
                        <input type="radio" name="payment_method" value="nagad" id="payment_nagad" class="payment-radio">
                        <div class="payment-card">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 32px; color: #F47920;">üì±</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 16px; color: #F47920;">Nagad</div>
                                    <div style="font-size: 13px; color: #666;">Mobile banking payment</div>
                                </div>
                            </div>
                        </div>
                    </label>
                    
                    <!-- Rocket -->
                    <label class="payment-option">
                        <input type="radio" name="payment_method" value="rocket" id="payment_rocket" class="payment-radio">
                        <div class="payment-card">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 32px; color: #8B3AB7;">üì±</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 16px; color: #8B3AB7;">Rocket</div>
                                    <div style="font-size: 13px; color: #666;">Mobile banking payment</div>
                                </div>
                            </div>
                        </div>
                    </label>
                    
                    <!-- CellFin (Optional) -->
                    <label class="payment-option">
                        <input type="radio" name="payment_method" value="cellfin" id="payment_cellfin" class="payment-radio">
                        <div class="payment-card">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 32px; color: #0066CC;">üè¶</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 16px; color: #0066CC;">CellFin</div>
                                    <div style="font-size: 13px; color: #666;">Islami Bank banking</div>
                                </div>
                            </div>
                        </div>
                    </label>
                    
                </div>
                
                <div style="margin-top: 30px;">
                    <button type="submit" class="btn btn-success" id="submitBtn" style="width: 100%; padding: 15px; font-size: 18px; font-weight: 600;">
                        üîí Proceed to Payment
                    </button>
                    <a href="{% url 'product_detail' product.id %}" class="btn" style="width: 100%; padding: 15px; margin-top: 10px; text-align: center; display: inline-block; box-sizing: border-box;">
                        Cancel
                    </a>
                </div>
                
                <!-- Error Message Display -->
                <div id="errorMessage" style="display: none; margin-top: 20px; padding: 15px; background: #fee; border-radius: 8px; border-left: 4px solid #f44336; color: #c62828;">
                    <strong>‚ö†Ô∏è Error:</strong> <span id="errorText"></span>
                </div>
                
                <!-- Sandbox Demo Info Box -->
                <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);">
                    <div style="color: white; text-align: left;">
                        <h4 style="margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <span>üß™</span> SANDBOX MODE - Test Payment Demo
                        </h4>
                        <p style="margin: 0 0 15px 0; font-size: 14px; opacity: 0.95;">
                            <strong>This is a demo environment.</strong> No real money will be charged. Use the test credentials below:
                        </p>
                        
                        <div style="background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px); margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0; font-weight: 600; font-size: 13px;">üí≥ Test Credit/Debit Card:</p>
                            <div style="font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.8;">
                                <div>‚Ä¢ <strong>Card Number:</strong> 4111 1111 1111 1111</div>
                                <div>‚Ä¢ <strong>Expiry Date:</strong> 12/25 (any future date)</div>
                                <div>‚Ä¢ <strong>CVV:</strong> 123 (any 3 digits)</div>
                                <div>‚Ä¢ <strong>Cardholder:</strong> Test User (any name)</div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                            <p style="margin: 0 0 10px 0; font-weight: 600; font-size: 13px;">üì± Test Mobile Banking:</p>
                            <div style="font-size: 13px; line-height: 1.8;">
                                <div>‚Ä¢ Select bKash/Nagad/Rocket on gateway page</div>
                                <div>‚Ä¢ Use any test number provided by gateway</div>
                                <div>‚Ä¢ Click "Success" to simulate successful payment</div>
                                <div>‚Ä¢ Click "Fail" to simulate failed payment</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <div style="font-size: 13px; color: #1976D2;">
                        <strong>üîí Secure Payment:</strong> Payments are processed through SSLCommerz gateway. Currently in <strong>Sandbox Mode</strong> for testing. Your information is secure and never stored on our servers.
                    </div>
                </div>
            </form>
        </div>
        
    </div>
</div>

<script>
// Form validation
function validatePaymentForm() {
    const errorMsg = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const submitBtn = document.getElementById('submitBtn');
    
    // Hide any previous errors
    errorMsg.style.display = 'none';
    
    // Check if payment method is selected
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
    if (!paymentMethod) {
        errorText.textContent = 'Please select a payment method.';
        errorMsg.style.display = 'block';
        errorMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
    }
    
    // Get quantity and available stock
    const quantity = parseInt(document.getElementById('quantityInput').value);
    const availableStock = {{ product.quantity }};
    
    // Validate quantity
    if (isNaN(quantity) || quantity <= 0) {
        errorText.textContent = 'Invalid quantity. Please enter a valid number.';
        errorMsg.style.display = 'block';
        errorMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
    }
    
    // Check stock availability
    if (quantity > availableStock) {
        errorText.textContent = `Not enough stock available. Only ${availableStock} units in stock.`;
        errorMsg.style.display = 'block';
        errorMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
    }
    
    // Disable submit button to prevent double submission
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Processing...';
    submitBtn.style.opacity = '0.7';
    submitBtn.style.cursor = 'not-allowed';
    
    return true;
}

// Highlight selected payment method
document.querySelectorAll('.payment-radio').forEach(radio => {
    radio.addEventListener('change', function() {
        document.querySelectorAll('.payment-card').forEach(card => {
            card.style.borderColor = '#e0e0e0';
            card.style.background = '#fafafa';
            card.style.boxShadow = 'none';
        });
        
        if (this.checked) {
            const card = this.nextElementSibling;
            card.style.borderColor = '#4CAF50';
            card.style.background = '#f1f8f4';
            card.style.boxShadow = '0 4px 12px rgba(76, 175, 80, 0.2)';
        }
    });
});

// Initial highlight for default selection
window.addEventListener('DOMContentLoaded', function() {
    const defaultRadio = document.querySelector('.payment-radio:checked');
    if (defaultRadio) {
        defaultRadio.dispatchEvent(new Event('change'));
    }
});
</script>

<style>
.payment-option {
    display: block;
    margin-bottom: 15px;
    cursor: pointer;
}

.payment-option input[type="radio"] {
    display: none;
}

.payment-card {
    padding: 18px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    background: #fafafa;
    transition: all 0.3s ease;
}

.payment-option input[type="radio"]:checked + .payment-card {
    border-color: #4CAF50;
    background: #f1f8f4;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
}

.payment-card:hover {
    border-color: #4CAF50;
    background: #f9f9f9;
}
</style>

{% endblock %}
