{% extends 'base.html' %}
{% load static %}

{% block title %}Sales Analytics - Admin{% endblock %}

{% block content %}
<script src="{% static 'js/chart.min.js' %}"></script>
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #10b981;
    }
    
    .page-title {
        font-size: 32px;
        font-weight: 700;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .back-btn {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: transform 0.2s;
    }
    
    .back-btn:hover {
        transform: translateY(-2px);
    }

    .filter-chips {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        justify-content: flex-end;
    }

    .filter-chip {
        padding: 8px 16px;
        border-radius: 20px;
        border: 2px solid #e5e7eb;
        background: white;
        color: #6b7280;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .filter-chip:hover {
        border-color: #10b981;
        color: #10b981;
    }

    .filter-chip.active {
        background: linear-gradient(135deg, #10b981, #34d399);
        color: white;
        border-color: #10b981;
    }

    .trend-card {
        background: white;
        padding: 25px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
    }

    .chart-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f3f4f6;
    }

    .chart-title {
        font-size: 20px;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
    }

    .mini-chart-container {
        height: 200px;
        margin-bottom: 15px;
    }

    .bottom-charts {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-top: 30px;
    }

    .chart-card {
        background: white;
        padding: 25px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }

    .chart-card.green {
        border-top: 4px solid #10b981;
    }

    .chart-card.orange {
        border-top: 4px solid #f59e0b;
    }
</style>

<div class="page-header">
    <h1 class="page-title">
        <span>üìä</span>
        Sales Analytics
    </h1>
    <a href="{% url 'admin_dashboard' %}" class="back-btn">
        ‚¨ÖÔ∏è Back to Dashboard
    </a>
</div>

<!-- Filter Chips -->
<div class="filter-chips">
    <button class="filter-chip" onclick="loadData('today')">Today</button>
    <button class="filter-chip active" onclick="loadData('7d')">7 Days</button>
    <button class="filter-chip" onclick="loadData('30d')">30 Days</button>
</div>

<!-- 1. Revenue & Orders Trend Chart -->
<div class="trend-card">
    <div class="chart-header">
        <span style="font-size: 28px;">üìà</span>
        <h2 class="chart-title">Revenue & Orders Trend</h2>
    </div>
    <canvas id="trendChart" style="max-height: 300px;"></canvas>
</div>

<!-- SALES ANALYTICS SECTION -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 40px 0;">
    <!-- Most Selling Products -->
    <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 25px; border-radius: 20px; border-left: 5px solid #10b981; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.15);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #10b981;">
            <span style="font-size: 32px;">üìä</span>
            <h2 style="font-size: 22px; font-weight: 700; color: #065f46; margin: 0;">Most Selling Products</h2>
        </div>
        
        <!-- 2. Top Selling Products Bar Chart -->
        <div class="mini-chart-container">
            <canvas id="topSellingChart"></canvas>
        </div>
        
        {% if most_selling_products %}
        <div style="background: white; border-radius: 10px; overflow: hidden; max-height: 800px; overflow-y: auto;">
            <table style="width: 100%;">
                <thead style="position: sticky; top: 0; background: #10b981; z-index: 10;">
                    <tr style="color: white;">
                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 700;">#</th>
                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 700;">Product Name</th>
                        <th style="padding: 12px; text-align: center; font-size: 13px; font-weight: 700;">Quantity Sold</th>
                        <th style="padding: 12px; text-align: center; font-size: 13px; font-weight: 700;">Orders</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in most_selling_products %}
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 12px; font-weight: 700; color: #10b981; font-size: 16px;">{{ forloop.counter }}</td>
                        <td style="padding: 12px; font-weight: 600; color: #1f2937;">{{ product.product_name }}</td>
                        <td style="padding: 12px; text-align: center; font-weight: 700; color: #10b981; font-size: 18px;">{{ product.total_quantity }}</td>
                        <td style="padding: 12px; text-align: center; color: #6b7280; font-weight: 600;">{{ product.total_sales }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
            <p style="color: #6b7280; margin: 0;">No sales data available yet</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Highest Revenue Products -->
    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 25px; border-radius: 20px; border-left: 5px solid #f59e0b; box-shadow: 0 10px 30px rgba(245, 158, 11, 0.15);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f59e0b;">
            <span style="font-size: 32px;">üí∞</span>
            <h2 style="font-size: 22px; font-weight: 700; color: #92400e; margin: 0;">Highest Revenue Products</h2>
        </div>
        
        <!-- 3. Top Revenue Products Bar Chart -->
        <div class="mini-chart-container">
            <canvas id="topRevenueChart"></canvas>
        </div>
        
        {% if highest_revenue_products %}
        <div style="background: white; border-radius: 10px; overflow: hidden; max-height: 800px; overflow-y: auto;">
            <table style="width: 100%;">
                <thead style="position: sticky; top: 0; background: #f59e0b; z-index: 10;">
                    <tr style="color: white;">
                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 700;">#</th>
                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 700;">Product Name</th>
                        <th style="padding: 12px; text-align: center; font-size: 13px; font-weight: 700;">Total Revenue</th>
                        <th style="padding: 12px; text-align: center; font-size: 13px; font-weight: 700;">Orders</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in highest_revenue_products %}
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 12px; font-weight: 700; color: #f59e0b; font-size: 16px;">{{ forloop.counter }}</td>
                        <td style="padding: 12px; font-weight: 600; color: #1f2937;">{{ product.product_name }}</td>
                        <td style="padding: 12px; text-align: center; font-weight: 700; color: #f59e0b; font-size: 18px;">‡ß≥{{ product.total_revenue|floatformat:2 }}</td>
                        <td style="padding: 12px; text-align: center; color: #6b7280; font-weight: 600;">{{ product.total_sales }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
            <p style="color: #6b7280; margin: 0;">No revenue data available yet</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Bottom Charts -->
<div class="bottom-charts">
    <!-- 4. Category Share Donut Chart -->
    <div class="chart-card green">
        <div class="chart-header">
            <span style="font-size: 24px;">ü•ß</span>
            <h2 class="chart-title">Category Revenue Share</h2>
        </div>
        <canvas id="categoryChart" style="max-height: 300px;"></canvas>
    </div>

    <!-- 5. Orders Heatmap -->
    <div class="chart-card orange">
        <div class="chart-header">
            <span style="font-size: 24px;">üî•</span>
            <h2 class="chart-title">Peak Order Times</h2>
        </div>
        <canvas id="heatmapChart" style="max-height: 300px;"></canvas>
    </div>
</div>

<script>
// Chart.js Configuration
Chart.defaults.font.family = "'Inter', 'Segoe UI', sans-serif";
Chart.defaults.color = '#6b7280';

// 1. Revenue & Orders Trend Chart
const trendCtx = document.getElementById('trendChart').getContext('2d');
const trendChart = new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
        datasets: [
            {
                label: 'Revenue (‡ß≥)',
                data: [12000, 19000, 15000, 25000, 22000, 30000, 28000],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#10b981',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            },
            {
                label: 'Orders',
                data: [30, 45, 38, 60, 55, 70, 65],
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#6366f1',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                yAxisID: 'y1'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    usePointStyle: true,
                    padding: 20,
                    font: {
                        size: 13,
                        weight: '600'
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: {
                    size: 14,
                    weight: 'bold'
                },
                bodyFont: {
                    size: 13
                },
                borderColor: '#10b981',
                borderWidth: 1
            }
        },
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    callback: function(value) {
                        return '‡ß≥' + value.toLocaleString();
                    }
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                grid: {
                    drawOnChartArea: false,
                },
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// 2. Top Selling Products Bar Chart
const topSellingCtx = document.getElementById('topSellingChart').getContext('2d');
const topSellingData = [
    {% for product in most_selling_products|slice:":5" %}
        { name: '{{ product.product_name|truncatechars:20 }}', quantity: {{ product.total_quantity }} }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

new Chart(topSellingCtx, {
    type: 'bar',
    data: {
        labels: topSellingData.map(p => p.name),
        datasets: [{
            label: 'Quantity Sold',
            data: topSellingData.map(p => p.quantity),
            backgroundColor: [
                'rgba(16, 185, 129, 0.8)',
                'rgba(52, 211, 153, 0.8)',
                'rgba(110, 231, 183, 0.8)',
                'rgba(167, 243, 208, 0.8)',
                'rgba(209, 250, 229, 0.8)'
            ],
            borderColor: [
                '#10b981',
                '#34d399',
                '#6ee7b7',
                '#a7f3d0',
                '#d1fae5'
            ],
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false,
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                    label: function(context) {
                        return 'Sold: ' + context.parsed.x + ' units';
                    }
                }
            }
        },
        scales: {
            x: {
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: {
                        size: 11
                    }
                }
            },
            y: {
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        size: 11,
                        weight: '600'
                    }
                }
            }
        }
    }
});

// 3. Top Revenue Products Bar Chart
const topRevenueCtx = document.getElementById('topRevenueChart').getContext('2d');
const topRevenueData = [
    {% for product in highest_revenue_products|slice:":5" %}
        { name: '{{ product.product_name|truncatechars:20 }}', revenue: {{ product.total_revenue }} }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

new Chart(topRevenueCtx, {
    type: 'bar',
    data: {
        labels: topRevenueData.map(p => p.name),
        datasets: [{
            label: 'Revenue (‡ß≥)',
            data: topRevenueData.map(p => p.revenue),
            backgroundColor: [
                'rgba(245, 158, 11, 0.8)',
                'rgba(251, 191, 36, 0.8)',
                'rgba(252, 211, 77, 0.8)',
                'rgba(253, 224, 71, 0.8)',
                'rgba(254, 243, 199, 0.8)'
            ],
            borderColor: [
                '#f59e0b',
                '#fbbf24',
                '#fcd34d',
                '#fde047',
                '#fef3c7'
            ],
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false,
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                    label: function(context) {
                        return 'Revenue: ‡ß≥' + context.parsed.x.toLocaleString();
                    }
                }
            }
        },
        scales: {
            x: {
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: {
                        size: 11
                    },
                    callback: function(value) {
                        return '‡ß≥' + value.toLocaleString();
                    }
                }
            },
            y: {
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        size: 11,
                        weight: '600'
                    }
                }
            }
        }
    }
});

// 4. Category Share Donut Chart
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
        labels: ['Vegetables', 'Fruits', 'Dairy', 'Meat', 'Grains'],
        datasets: [{
            data: [35, 25, 20, 12, 8],
            backgroundColor: [
                '#10b981',
                '#34d399',
                '#6ee7b7',
                '#a7f3d0',
                '#d1fae5'
            ],
            borderWidth: 0,
            hoverOffset: 15
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    padding: 15,
                    font: {
                        size: 12,
                        weight: '600'
                    },
                    usePointStyle: true,
                    pointStyle: 'circle'
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed + '%';
                    }
                }
            }
        },
        cutout: '65%'
    }
});

// 5. Orders Heatmap (Bar Chart simulating heatmap)
const heatmapCtx = document.getElementById('heatmapChart').getContext('2d');
new Chart(heatmapCtx, {
    type: 'bar',
    data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
            label: 'Orders',
            data: [45, 55, 60, 70, 85, 95, 50],
            backgroundColor: function(context) {
                const value = context.parsed.y;
                if (value > 80) return '#ef4444';
                if (value > 60) return '#f59e0b';
                if (value > 40) return '#fbbf24';
                return '#fde047';
            },
            borderRadius: 8,
            borderSkipped: false,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                    label: function(context) {
                        return 'Orders: ' + context.parsed.y;
                    }
                }
            }
        },
        scales: {
            y: {
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: {
                        size: 11
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        size: 11,
                        weight: '600'
                    }
                }
            }
        }
    }
});

// Filter Chips Functionality
function loadData(period) {
    // Remove active class from all chips
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
    });
    
    // Add active class to clicked chip
    event.target.classList.add('active');
    
    // Here you can add AJAX call to load data based on period
    console.log('Loading data for:', period);
}
</script>

{% endblock %}
